-- Services
local Players          = game:GetService("Players")
local TweenService     = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService       = game:GetService("RunService")

-- Local player
local localPlayer = Players.LocalPlayer

-- UI colors and toggle key
local menuBackgroundColor = Color3.fromRGB(34, 34, 34)
local titleBackgroundColor = Color3.fromRGB(44, 44, 44)
local toggleKey = Enum.KeyCode.F
local manualClosed = false

-- Connections for ongoing effects
local bangConnection, bangV2Connection, headsitConnection, lookAtMeConnection, stepOnMeConnection

--------------------------------------------------------------------------------
-- FUNCTION DEFINITIONS
--------------------------------------------------------------------------------

-- Teleport to target player
local function teleportToTarget(player)
    if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
        localPlayer.Character:MoveTo(player.Character.HumanoidRootPart.Position)
    end
end

-- Spectate: point camera at target player’s head
local function spectatePlayer(player)
    if player and player.Character and player.Character:FindFirstChild("Head") then
        workspace.CurrentCamera.CameraSubject = player.Character.Head
    end
end

-- Stop spectating: return camera to local player
local function stopSpectate()
    if localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then
        workspace.CurrentCamera.CameraSubject = localPlayer.Character.Humanoid
    end
end

-- Toggle selection boxes on all BaseParts to make invisible players visible
local function toggleAntiInvisible(player)
    if not (player and player.Character) then return end
    local hasBoxes = false
    for _, part in ipairs(player.Character:GetDescendants()) do
        if part:IsA("BasePart") and part:FindFirstChild("AntiInvisibleBox") then
            hasBoxes = true
            break
        end
    end

    for _, part in ipairs(player.Character:GetDescendants()) do
        if part:IsA("BasePart") then
            local box = part:FindFirstChild("AntiInvisibleBox")
            if hasBoxes then
                if box then box:Destroy() end
            else
                local sel = Instance.new("SelectionBox")
                sel.Name                = "AntiInvisibleBox"
                sel.Adornee             = part
                sel.LineThickness       = 0.05
                sel.SurfaceTransparency = 0.5
                sel.Color3              = Color3.fromRGB(255, 0, 0)
                sel.Parent              = part
            end
        end
    end
end

-- Bang (oscillate behind target)
local function doBang(player)
    if bangConnection then
        bangConnection:Disconnect()
        bangConnection = nil
        if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            localPlayer.Character.HumanoidRootPart.Velocity = Vector3.new()
        end
    elseif player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then

        local startTime = tick()
        bangConnection = RunService.Heartbeat:Connect(function()
            if not (player.Character and player.Character:FindFirstChild("HumanoidRootPart")) then
                bangConnection:Disconnect()
                bangConnection = nil
                return
            end
            local targetHRP = player.Character.HumanoidRootPart
            local myHRP     = localPlayer.Character.HumanoidRootPart
            local offset    = math.sin((tick() - startTime) * 30) * 2
            local behindPos = targetHRP.Position - targetHRP.CFrame.LookVector * 3
            myHRP.CFrame    = CFrame.new(behindPos + targetHRP.CFrame.LookVector * offset, targetHRP.Position)
        end)
    end
end

-- Bang V2 (tiny oscillation close to target)
local function doBangV2(player)
    if bangV2Connection then
        bangV2Connection:Disconnect()
        bangV2Connection = nil
        if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            localPlayer.Character.HumanoidRootPart.Velocity = Vector3.new()
        end
    elseif player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then

        local targetHRP = player.Character.HumanoidRootPart
        local myHRP     = localPlayer.Character.HumanoidRootPart
        local startTime = tick()
        bangV2Connection = RunService.Heartbeat:Connect(function()
            if not (player.Character and targetHRP) then
                bangV2Connection:Disconnect()
                bangV2Connection = nil
                return
            end
            local pos   = targetHRP.Position
            local look  = targetHRP.CFrame.LookVector
            local base  = pos - look * 0.5
            local offset = math.sin((tick() - startTime) * 50) * 0.2
            myHRP.CFrame = CFrame.new(base + look * offset, pos)
        end)
    end
end

-- Headsit: sit on the target’s head
local function doHeadsit(player)
    if headsitConnection then
        headsitConnection:Disconnect()
        headsitConnection = nil
        if localPlayer.Character then
            local hrp = localPlayer.Character:FindFirstChild("HumanoidRootPart")
            if hrp then hrp.Velocity = Vector3.new() end
            local hum = localPlayer.Character:FindFirstChild("Humanoid")
            if hum then hum.Sit = false end
        end
    elseif player and player.Character and player.Character:FindFirstChild("Head")
        and localPlayer.Character and localPlayer.Character:FindFirstChild("Humanoid") then

        localPlayer.Character.Humanoid.Sit = true
        local head = player.Character.Head
        headsitConnection = RunService.Heartbeat:Connect(function()
            if not (player.Character and player.Character:FindFirstChild("Head")) then
                headsitConnection:Disconnect()
                headsitConnection = nil
                return
            end
            local newCF = head.CFrame * CFrame.new(0, head.Size.Y / 2, 0)
            localPlayer.Character.HumanoidRootPart.CFrame = newCF
        end)
    end
end

-- Look At Me: position yourself 5 studs in front of the target, facing them
local function doLookAtMe(player)
    if lookAtMeConnection then
        lookAtMeConnection:Disconnect()
        lookAtMeConnection = nil
    elseif player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then

        lookAtMeConnection = RunService.Heartbeat:Connect(function()
            local targetHRP = player.Character:FindFirstChild("HumanoidRootPart")
            local myHRP     = localPlayer.Character:FindFirstChild("HumanoidRootPart")
            if not (targetHRP and myHRP) then
                lookAtMeConnection:Disconnect()
                lookAtMeConnection = nil
                return
            end
            local newPos = targetHRP.Position + targetHRP.CFrame.LookVector * 5
            myHRP.CFrame = CFrame.new(newPos, targetHRP.Position)
        end)
    end
end

-- Step On Me: position yourself directly under the target
local function doStepOnMe(player)
    if stepOnMeConnection then
        stepOnMeConnection:Disconnect()
        stepOnMeConnection = nil
        if localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
            localPlayer.Character.HumanoidRootPart.Velocity = Vector3.new()
        end
    elseif player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then

        local targetHRP = player.Character.HumanoidRootPart
        local myHRP     = localPlayer.Character.HumanoidRootPart
        local offsetY   = localPlayer.Character:FindFirstChild("UpperTorso") and 3 or 6

        stepOnMeConnection = RunService.Heartbeat:Connect(function()
            if not (targetHRP and myHRP) then
                stepOnMeConnection:Disconnect()
                stepOnMeConnection = nil
                return
            end
            local newPos = targetHRP.Position - Vector3.new(0, offsetY, 0)
            myHRP.CFrame = CFrame.new(newPos) * CFrame.Angles(math.rad(90), 0, 0)
        end)
    end
end

-- Doggy: teleport directly behind the target
local function doDoggy(player)
    if player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
       and localPlayer.Character and localPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local tHRP = player.Character.HumanoidRootPart
        local mHRP = localPlayer.Character.HumanoidRootPart
        mHRP.CFrame = CFrame.new(tHRP.Position - Vector3.new(0, 3, 0), tHRP.Position)
    end
end

--------------------------------------------------------------------------------
-- GUI SETUP
--------------------------------------------------------------------------------

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PlayerListGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = localPlayer:WaitForChild("PlayerGui")

-- Notice Frame
local noticeFrame = Instance.new("Frame")
noticeFrame.Name               = "NoticeFrame"
noticeFrame.Size               = UDim2.new(0, 350, 0, 250)
noticeFrame.Position           = UDim2.new(0.5, -175, 0.5, -125)
noticeFrame.BackgroundColor3   = menuBackgroundColor
noticeFrame.BorderSizePixel    = 0
noticeFrame.Parent             = screenGui

local noticeTitle = Instance.new("TextLabel")
noticeTitle.Name                = "NoticeTitle"
noticeTitle.Size                = UDim2.new(1, 0, 0, 60)
noticeTitle.Position            = UDim2.new(0, 0, 0, 0)
noticeTitle.BackgroundTransparency = 1
noticeTitle.Text                = "Notice"
noticeTitle.TextColor3          = Color3.fromRGB(240, 240, 240)
noticeTitle.Font                = Enum.Font.SourceSansBold
noticeTitle.TextSize            = 28
noticeTitle.Parent              = noticeFrame

local noticeText = Instance.new("TextLabel")
noticeText.Name                  = "NoticeText"
noticeText.Size                  = UDim2.new(1, -20, 0, 140)
noticeText.Position              = UDim2.new(0, 10, 0, 60)
noticeText.BackgroundTransparency = 1
noticeText.Text                  = "This script was created by Tapetenputzer.\nFor more info: https://discord.gg/2xDHnGg6cJ"
noticeText.TextColor3            = Color3.fromRGB(240,240,240)
noticeText.Font                  = Enum.Font.SourceSans
noticeText.TextSize              = 20
noticeText.TextWrapped           = true
noticeText.Parent                = noticeFrame

local noticeOK = Instance.new("TextButton")
noticeOK.Name                    = "NoticeOK"
noticeOK.Size                    = UDim2.new(0, 120, 0, 50)
noticeOK.Position                = UDim2.new(0.5, -60, 1, -60)
noticeOK.BackgroundColor3        = Color3.fromRGB(0, 120, 200)
noticeOK.Text                    = "OK"
noticeOK.Font                    = Enum.Font.SourceSansBold
noticeOK.TextSize                = 24
noticeOK.TextColor3              = Color3.fromRGB(255,255,255)
noticeOK.Parent                  = noticeFrame

noticeOK.MouseButton1Click:Connect(function()
    noticeFrame:Destroy()
    mainFrame.Visible = true
end)

-- Main Frame (Player List)
local mainFrame = Instance.new("Frame")
mainFrame.Name               = "MainFrame"
mainFrame.Size               = UDim2.new(0, 400, 0, 500)
mainFrame.Position           = UDim2.new(0, 30, 0, 120)
mainFrame.BackgroundColor3   = menuBackgroundColor
mainFrame.BorderSizePixel    = 0
mainFrame.Active             = true
mainFrame.Selectable         = true
mainFrame.Visible            = false
mainFrame.Parent             = screenGui

noticeFrame.Destroying:Connect(function()
    mainFrame.Visible = true
end)

local titleLabel = Instance.new("TextLabel")
titleLabel.Name                = "TitleLabel"
titleLabel.Size                = UDim2.new(1, -100, 0, 50)
titleLabel.Position            = UDim2.new(0, 0, 0, 0)
titleLabel.BackgroundColor3    = titleBackgroundColor
titleLabel.BorderSizePixel     = 0
titleLabel.Text                = "Player List"
titleLabel.TextColor3          = Color3.fromRGB(240,240,240)
titleLabel.Font                = Enum.Font.SourceSansBold
titleLabel.TextSize            = 28
titleLabel.Parent              = mainFrame

local closeButton = Instance.new("TextButton")
closeButton.Name                = "CloseButton"
closeButton.Size                = UDim2.new(0, 40, 0, 40)
closeButton.Position            = UDim2.new(1, -45, 0, 10)
closeButton.BackgroundColor3    = Color3.fromRGB(200, 0, 0)
closeButton.Text                = "X"
closeButton.Font                = Enum.Font.SourceSansBold
closeButton.TextSize            = 28
closeButton.TextColor3          = Color3.fromRGB(255,255,255)
closeButton.Parent              = mainFrame

closeButton.MouseButton1Click:Connect(function()
    screenGui.Enabled = false
    manualClosed = true
end)

local settingsButton = Instance.new("TextButton")
settingsButton.Name             = "SettingsButton"
settingsButton.Size             = UDim2.new(0, 40, 0, 40)
settingsButton.Position         = UDim2.new(1, -90, 0, 10)
settingsButton.BackgroundColor3 = Color3.fromRGB(0, 120, 200)
settingsButton.Text             = "⚙"
settingsButton.Font             = Enum.Font.SourceSansBold
settingsButton.TextSize         = 28
settingsButton.TextColor3       = Color3.fromRGB(255,255,255)
settingsButton.Parent           = mainFrame

local searchBox = Instance.new("TextBox")
searchBox.Name                    = "SearchBox"
searchBox.Size                    = UDim2.new(1, -20, 0, 40)
searchBox.Position                = UDim2.new(0, 10, 0, 70)
searchBox.BackgroundColor3        = Color3.fromRGB(55,55,55)
searchBox.BorderSizePixel         = 0
searchBox.PlaceholderText         = "Search player..."
searchBox.TextColor3              = Color3.fromRGB(240,240,240)
searchBox.Font                    = Enum.Font.SourceSans
searchBox.TextSize                = 20
searchBox.ClearTextOnFocus        = false
searchBox.Parent                  = mainFrame

local scrollingFrame = Instance.new("ScrollingFrame")
scrollingFrame.Name                = "PlayersScrollingFrame"
scrollingFrame.Size                = UDim2.new(1, 0, 1, -120)
scrollingFrame.Position            = UDim2.new(0, 0, 0, 120)
scrollingFrame.BackgroundTransparency= 1
scrollingFrame.ScrollBarThickness  = 8
scrollingFrame.Parent              = mainFrame

local uiListLayout = Instance.new("UIListLayout")
uiListLayout.Parent                = scrollingFrame
uiListLayout.HorizontalAlignment   = Enum.HorizontalAlignment.Left
uiListLayout.SortOrder             = Enum.SortOrder.LayoutOrder
uiListLayout.Padding               = UDim.new(0, 8)

-- Details Frame
local detailsFrame = Instance.new("Frame")
detailsFrame.Name                = "DetailsFrame"
detailsFrame.Size                = UDim2.new(0, 400, 0, 550)
detailsFrame.Position            = UDim2.new(0.5, -200, 0.5, -275)
detailsFrame.BackgroundColor3    = menuBackgroundColor
detailsFrame.BorderSizePixel     = 0
detailsFrame.Active              = true
detailsFrame.Selectable          = true
detailsFrame.Visible             = false
detailsFrame.Parent              = screenGui

local backButton = Instance.new("TextButton")
backButton.Name                = "BackButton"
backButton.Size                = UDim2.new(0, 40, 0, 40)
backButton.Position            = UDim2.new(1, -50, 0, 10)
backButton.BackgroundColor3    = Color3.fromRGB(200, 0, 0)
backButton.Text                = "<"
backButton.Font                = Enum.Font.SourceSansBold
backButton.TextSize            = 28
backButton.TextColor3          = Color3.fromRGB(255,255,255)
backButton.Parent              = detailsFrame

backButton.MouseButton1Click:Connect(function()
    detailsFrame.Visible = false
end)

local detailTitle = Instance.new("TextLabel")
detailTitle.Name               = "DetailTitle"
detailTitle.Size               = UDim2.new(1, -60, 0, 50)
detailTitle.Position           = UDim2.new(0, 0, 0, 0)
detailTitle.BackgroundColor3   = titleBackgroundColor
detailTitle.BorderSizePixel    = 0
detailTitle.Text               = "Player Details"
detailTitle.TextColor3         = Color3.fromRGB(240,240,240)
detailTitle.Font               = Enum.Font.SourceSansBold
detailTitle.TextSize           = 28
detailTitle.Parent             = detailsFrame

local detailContainer = Instance.new("Frame")
detailContainer.Name               = "DetailContainer"
detailContainer.Size               = UDim2.new(1, 0, 1, -60)
detailContainer.Position           = UDim2.new(0, 0, 0, 60)
detailContainer.BackgroundTransparency= 1
detailContainer.Parent             = detailsFrame

local infoImageFrame = Instance.new("Frame")
infoImageFrame.Name                  = "InfoImageFrame"
infoImageFrame.Size                  = UDim2.new(1, -20, 0, 120)
infoImageFrame.Position              = UDim2.new(0, 10, 0, 0)
infoImageFrame.BackgroundTransparency= 1
infoImageFrame.Parent                = detailContainer

local infoLayout = Instance.new("UIListLayout")
infoLayout.Parent                    = infoImageFrame
infoLayout.FillDirection             = Enum.FillDirection.Horizontal
infoLayout.HorizontalAlignment       = Enum.HorizontalAlignment.Left
infoLayout.VerticalAlignment         = Enum.VerticalAlignment.Center
infoLayout.Padding                   = UDim.new(0, 10)

local detailInfo = Instance.new("TextLabel")
detailInfo.Name               = "DetailInfo"
detailInfo.Size               = UDim2.new(0, 0.6 * infoImageFrame.AbsoluteSize.X, 1, 0) -- will auto-scale
detailInfo.BackgroundTransparency = 1
detailInfo.TextColor3         = Color3.fromRGB(240,240,240)
detailInfo.Font               = Enum.Font.SourceSans
detailInfo.TextSize           = 22
detailInfo.TextWrapped        = true
detailInfo.Parent             = infoImageFrame

local playerImage = Instance.new("ImageLabel")
playerImage.Name               = "PlayerImage"
playerImage.Size               = UDim2.new(0, 0.4 * infoImageFrame.AbsoluteSize.X, 1, 0) -- will auto-scale
playerImage.BackgroundTransparency = 1
playerImage.Parent             = infoImageFrame

local detailButtonFrame = Instance.new("Frame")
detailButtonFrame.Name              = "DetailButtonFrame"
detailButtonFrame.Size              = UDim2.new(1, -20, 1, -130)
detailButtonFrame.Position          = UDim2.new(0, 10, 0, 130)
detailButtonFrame.BackgroundTransparency= 1
detailButtonFrame.Parent            = detailContainer

local detailGrid = Instance.new("UIGridLayout")
detailGrid.Parent                   = detailButtonFrame
detailGrid.CellSize                 = UDim2.new(0, 180, 0, 50)
detailGrid.CellPadding              = UDim2.new(0, 10, 0, 10)

-- Helper to create buttons with hover-pointer
local function createActionButton(text, startCallback, stopCallback)
    local btn = Instance.new("TextButton")
    btn.Size             = UDim2.new(0, 180, 0, 50)
    btn.BackgroundColor3 = Color3.fromRGB(70,70,70)
    btn.BorderSizePixel  = 0
    btn.Text             = text
    btn.Font             = Enum.Font.SourceSansBold
    btn.TextSize         = 22
    btn.TextColor3       = Color3.fromRGB(240,240,240)
    btn.Parent           = detailButtonFrame

    btn.MouseEnter:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(90,90,90)}):Play()
        localPlayer:GetMouse().Icon = "rbxasset://SystemCursors/Hand"
    end)
    btn.MouseLeave:Connect(function()
        TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(70,70,70)}):Play()
        localPlayer:GetMouse().Icon = ""
    end)

    if stopCallback then
        local toggled, originalText = false, text
        btn.MouseButton1Click:Connect(function()
            if not toggled then
                startCallback()
                toggled = true
                btn.Text = "Stop"
            else
                stopCallback()
                toggled = false
                btn.Text = originalText
            end
        end)
    else
        btn.MouseButton1Click:Connect(startCallback)
    end
end

-- Show player details in detail frame
local function showPlayerDetails(player)
    local age = player.AccountAge
    local creationDate = os.date("%d.%m.%Y", os.time() - age * 24 * 3600)
    detailInfo.Text = string.format(
        "Name: %s\nUserID: %d\nDisplay: %s\nAccount Age: %d days\nCreated: %s",
        player.Name, player.UserId, player.DisplayName, age, creationDate
    )

    local success, thumbnail = pcall(function()
        return Players:GetUserThumbnailAsync(player.UserId,
            Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size420x420)
    end)
    playerImage.Image = success and thumbnail or "rbxassetid://0"

    -- Clear old buttons
    for _, child in ipairs(detailButtonFrame:GetChildren()) do
        if child:IsA("TextButton") then child:Destroy() end
    end

    -- Create action buttons
    createActionButton("Teleport",      function() teleportToTarget(player) end)
    createActionButton("Spectate",      function() spectatePlayer(player) end, stopSpectate)
    createActionButton("Look At Me",    function() doLookAtMe(player) end,    function() doLookAtMe(player) end)
    createActionButton("Step On Me",    function() doStepOnMe(player) end,    function() doStepOnMe(player) end)
    createActionButton("Bang V2",       function() doBangV2(player) end,      function() doBangV2(player) end)
    createActionButton("Anti Invisible",function() toggleAntiInvisible(player) end,
                                                   function() toggleAntiInvisible(player) end)
    createActionButton("Bang",          function() doBang(player) end,        function() doBang(player) end)
    createActionButton("Headsit",       function() doHeadsit(player) end,     function() doHeadsit(player) end)

    detailsFrame.Visible = true
end

-- Create a list entry for a player
local function createPlayerEntry(player)
    local entry = Instance.new("TextButton")
    entry.Name               = player.Name .. "_Entry"
    entry.Size               = UDim2.new(1, -10, 0, 50)
    entry.BackgroundColor3   = Color3.fromRGB(50,50,50)
    entry.BorderSizePixel    = 0
    entry.Text               = player.Name
    entry.Font               = Enum.Font.SourceSansBold
    entry.TextSize           = 22
    entry.TextColor3         = Color3.fromRGB(240,240,240)
    entry.Parent             = scrollingFrame

    entry.MouseButton1Click:Connect(function()
        showPlayerDetails(player)
    end)
    entry.MouseEnter:Connect(function()
        localPlayer:GetMouse().Icon = "rbxasset://SystemCursors/Hand"
    end)
    entry.MouseLeave:Connect(function()
        localPlayer:GetMouse().Icon = ""
    end)
end

-- Search filter
searchBox:GetPropertyChangedSignal("Text"):Connect(function()
    local query = string.lower(searchBox.Text or "")
    for _, child in ipairs(scrollingFrame:GetChildren()) do
        if child:IsA("TextButton") then
            local name = child.Name:match("^(.*)_Entry$")
            child.Visible = (query == "" or string.find(string.lower(name), query))
        end
    end
end)

-- Populate existing players
for _, player in ipairs(Players:GetPlayers()) do
    createPlayerEntry(player)
end
Players.PlayerAdded:Connect(createPlayerEntry)
Players.PlayerRemoving:Connect(function(player)
    local entry = scrollingFrame:FindFirstChild(player.Name .. "_Entry")
    if entry then entry:Destroy() end
end)

-- Click on 3D character to open details (ignoring UI clicks)
local mouse = localPlayer:GetMouse()
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or input.UserInputType ~= Enum.UserInputType.MouseButton1 then return end
    local target = mouse.Target
    if target then
        local model = target:FindFirstAncestorOfClass("Model")
        local plr   = model and Players:GetPlayerFromCharacter(model)
        if plr then
            showPlayerDetails(plr)
        end
    end
end)

-- Show hand-pointer when hovering over clickable characters
mouse.Move:Connect(function()
    local target = mouse.Target
    local model = target and target:FindFirstAncestorOfClass("Model")
    if model and Players:GetPlayerFromCharacter(model) then
        mouse.Icon = "rbxasset://SystemCursors/Hand"
    else
        mouse.Icon = ""
    end
end)

-- Make frames draggable
local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end

    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos  = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

makeDraggable(mainFrame)
makeDraggable(detailsFrame)

-- Toggle main GUI with F key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == toggleKey and not manualClosed then
        screenGui.Enabled = not screenGui.Enabled
    end
end)
